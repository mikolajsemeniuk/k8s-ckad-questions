apiVersion: v1
kind: Pod
metadata:
  name: my-multi-container-pod # Name of the Pod
  namespace: default # Namespace where the Pod will be created
  labels:
    app: myapp # Labels to identify the Pod
    tier: backend # Additional label for categorizing the Pod
  annotations:
    description: "This is a sample pod with multiple containers, volume mounts, and advanced configurations." # Annotations provide metadata that can be used by external tools

spec:
  restartPolicy: Always # Restart policy for the Pod (Always, OnFailure, Never)
  dnsPolicy: Default # DNS policy for the Pod
  hostNetwork: false # Whether to use the host's network namespace
  nodeName: node-1 # Node name to schedule the Pod on
  hostname: my-pod-hostname # Hostname for the Pod
  subdomain: my-subdomain # Subdomain for the Pod
  serviceAccountName: my-service-account # Service account to be used
  priorityClassName: high-priority # Priority class for the Pod
  schedulerName: default-scheduler # Scheduler to be used
  imagePullSecrets:
    - name: myregistrykey # Secret for pulling images from a private registry

  securityContext:
    runAsUser: 1000 # Run containers as this user
    fsGroup: 2000 # File system group for the Pod
    # only supported on container level and not pod
    # capabilities:
    # add: ["MAC_ADMIN"]
    # drop: ["ALL"]
    # allowPrivilegeEscalation: false  # add
    # privileged: false                # add
  containers:
    - name: ubuntu-container # Name of the container
      image: ubuntu # Container image
      command: ["/bin/sh"] # Command to run in the container
      args: ["-c", "echo Hello Kubernetes! && sleep 3600"] # Arguments for the command
      ports:
        - containerPort: 8080 # Port exposed by the container
          hostPort: 8080
      env:
        - name: ENV_VAR_1
          value: "value1" # Static environment variable
        - name: ENV_VAR_2
          valueFrom:
            configMapKeyRef:
              name: myconfigmap # Reference to a Kubernetes ConfigMap
              key: config_key
        - name: ENV_VAR_3
          valueFrom:
            secretKeyRef:
              name: mysecret # Reference to a Kubernetes secret
              key: password # Key within the secret
      envFrom:
        - configMapRef:
            name: my-config-map # References a ConfigMap for environment variables
        - secretRef:
            name: mysecret
      resources:
        requests:
          memory: "64Mi" # Memory request
          cpu: "250m" # CPU request
        limits:
          memory: "128Mi" # Memory limit
          cpu: "500m" # CPU limit
      volumeMounts:
        - name: config-volume
          mountPath: /etc/config # Mounts the volume at /etc/config
          readOnly: true
      livenessProbe:
        httpGet:
          path: /healthz # Path to check for liveness
          port: 8080
        initialDelaySeconds: 3 # Delay before starting probes
        periodSeconds: 3 # Probe interval
        tcpSocket:
          port: 3306
      readinessProbe:
        exec:
          command: ["cat", "tmp"]
        initialDelaySeconds: 5
        periodSeconds: 10 # This field defines how often (in seconds) the readinessProbe is executed.
        failureThreshold: 1 # This field defines the number of consecutive failed probe attempts that Kubernetes will tolerate before considering the container as not ready.

    - name: nginx-container # Second container in the Pod
      image: nginx # Container image
      ports:
        - containerPort: 80 # Port exposed by the container
      volumeMounts:
        - name: html
          mountPath: /usr/share/nginx/html # Mounts the volume at /usr/share/nginx/html

  initContainers:
    - name: init-myservice
      image: busybox
      command: [
          "sh",
          "-c",
          "until nslookup myservice; do echo waiting for myservice; sleep 2; done;",
        ] # Command to run in the init container

  volumes:
    - name: config-volume
      configMap:
        name: my-config-map # ConfigMap to be used as a volume

    - name: secret-volume
      secret:
        secretName: my-secret

    - name: x
      persistentVolumeClaim:
        claimName: x

    - name: html
      hostPath:
        path: /data
        type: Directory # Can be Directory, File, Socket, or CharDevice

    - name: cache-volume
      emptyDir: {}

    - name: azure-file-volume
      azureFile:
        secretName: azure-secret # Secret containing storage credentials
        shareName: my-share
        readOnly: true

    - name: ebs-volume
      awsElasticBlockStore:
        volumeID: vol-0abcdef1234567890
        fsType: ext4

  # kubectl label node [NODE_NAME] [LABEL_KEY]=[LABEL_VALUE]
  nodeSelector:
    size: Large
    kubernetes.io/hostname: controlplane

  # kubectl taint node [NODE_NAME] [KEY]=[VALUE]:[EFFECT]
  tolerations:
    - key: key1
      value: value1
      operator: Equal # Only Equal Exists
      effect: NoSchedule # Prevents new pods from being scheduled on the node. Existing pods remain unaffected.
    - key: key2
      operator: Exists
      effect: NoExecute # Prevents new pods from being scheduled on the node and evicts existing pods that do not tolerate the taint.
      tolerationSeconds: 3600 # Toleration with a time limit
    - key: key3
      operator: Exists
      effect: PreferNoSchedule

  affinity:
    ############################################################
    # ðŸ§± NODE AFFINITY â€” dopasowanie do etykiet NODE'Ã“W
    ############################################################
    nodeAffinity:
      # ðŸ”¸ Twarde wymagania â€” Pod zostanie zaplanowany tylko na node,
      # ktÃ³ry speÅ‚nia jeden z poniÅ¼szych nodeSelectorTerms
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
              - key: kubernetes.io/e2e-az-name
                operator: In # Node label value must be in the list
                values:
                  - e2e-az1
              - key: size
                operator: NotIn # Node label value must NOT be in the list
                values:
                  - small
              - key: disk-type
                operator: Exists # Node must have this label (any value)
              - key: gpu
                operator: DoesNotExist # Node must NOT have this label
              - key: cpu-count
                operator: Gt # Node label value (numeric) must be > X
                values:
                  - "4"
              - key: memory-size-gb
                operator: Lt # Node label value (numeric) must be < X
                values:
                  - "128"

      # ðŸ”¹ MiÄ™kkie preferencje â€” scheduler bÄ™dzie preferowaÅ‚ nody,
      # ktÃ³re speÅ‚niajÄ… poniÅ¼sze warunki, ale nie sÄ… one obowiÄ…zkowe
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 10
          preference:
            matchExpressions:
              - key: disk
                operator: In
                values:
                  - ssd
                  - nvme
        - weight: 5
          preference:
            matchExpressions:
              - key: performance-tier
                operator: Exists
        - weight: 3
          preference:
            matchExpressions:
              - key: temperature-zone
                operator: NotIn
                values:
                  - hot

    ############################################################
    # ðŸ¤ POD AFFINITY â€” wspÃ³Å‚lokacja z INNYMI PODAMI
    ############################################################
    podAffinity:
      # ðŸ”¸ Twarde wymagania â€” Pod musi byÄ‡ zaplanowany tam,
      # gdzie dziaÅ‚a inny Pod z odpowiednim labelem
      requiredDuringSchedulingIgnoredDuringExecution:
        - topologyKey: "kubernetes.io/hostname" # wspÃ³Å‚lokacja na tym samym node
          labelSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - backend
              - key: security
                operator: Exists
        - topologyKey: "topology.kubernetes.io/zone"
          labelSelector:
            matchLabels:
              tier: database

      # ðŸ”¹ MiÄ™kkie preferencje â€” scheduler preferuje, ale nie wymaga wspÃ³Å‚lokacji
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            topologyKey: "topology.kubernetes.io/region"
            labelSelector:
              matchExpressions:
                - key: env
                  operator: In
                  values:
                    - prod
        - weight: 50
          podAffinityTerm:
            topologyKey: "kubernetes.io/hostname"
            labelSelector:
              matchLabels:
                component: cache

    ############################################################
    # ðŸš« POD ANTI-AFFINITY â€” unikanie innych PODÃ“W
    ############################################################
    podAntiAffinity: {}
